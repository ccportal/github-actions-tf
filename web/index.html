<html>
  <head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://momentjs.com/downloads/moment.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js" integrity="sha512-CSBhVREyzHAjAFfBlIBakjoRUKp5h7VSweP0InR/pAJyptH7peuhCsqAI/snV+TwZmXZqoUklpXp6R6wMnYf5Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  </head>
  <body>
    <nav class="navbar bg-light">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <i class="bi bi-activity"></i>
          Business Continuity
        </a>
      </div>
    </nav>

    <div id="no-token-entered" class="container mt-3">
      <div class="input-group">
        <span class="input-group-text" id="basic-addon1">Github Personal Token</span>
        <input id="github-personal-token" type="text" class="form-control" placeholder="enter a valid token" aria-label="Username" aria-describedby="basic-addon1" onchange="personalTokenOnChange()" />
      </div>
      <div class="form-check mt-3">
        <input class="form-check-input" type="checkbox" id="remember-token" onchange="handleRememberCheck()" checked />
        <label class="form-check-label" for="remember-token"> Remember the token </label>
      </div>
      <button type="button" class="btn btn-primary mt-3" onclick="handleApplyToken()">Apply</button>
      <button type="button" class="btn btn-default mt-3" onclick="handleClearToken()">Clear</button>
    </div>
    <div>
      <label class="form-check-label" for="select-repository"> Repository:</label>
      <select class="form-select"  id="select-repository" onchange="handleSelectedRepository()">
        <option selected>Open this select menu</option>
        <option value="1">One</option>
        <option value="2">Two</option>
        <option value="3">Three</option></select>
    </div>
    <nav id="token-entered-tab-control">
      <div class="nav nav-tabs" id="nav-tab" role="tablist">
        <button class="nav-link active" id="nav-config-tab" data-bs-toggle="tab" data-bs-target="#nav-config" type="button" role="tab" aria-controls="nav-config" aria-selected="true">Configuration</button>
        <button class="nav-link" id="nav-profile-tab" data-bs-toggle="tab" data-bs-target="#nav-profile" type="button" role="tab" aria-controls="nav-profile" aria-selected="false">History</button>
      </div>
    </nav>

    <div id="token-entered-tab-content" class="tab-content" id="nav-tabContent">
      <div class="tab-pane fade show active" id="nav-config" role="tabpanel" aria-labelledby="nav-config-tab">
        <div class="container">
          <div class="row align-items-start">
            <div class="col">
                <div>Source</div>
                <label class="form-label">Client ID:</label>
                <input type="text" class="form-control" id="src_client_id" value="304bd193-4dd0-453b-858a-02ca6b64eb2d" />
                <label class="form-label">Client Secret:</label>
                <input type="text" class="form-control" id="src_client_secret/" value="jbnmSZTIMlHIxjY9LZ0YYlVrVYiAa6gDih30tk16ELY" />
                <label class="form-label">Region:</label>
                <input type="text" class="form-control" id="src_region" value="mypurecloud.ie" />
              <br />
            </div>
            <div class="col">
              <div>Destination</div>
              <label class="form-label">Client ID:</label>
              <input type="text" class="form-control" id="dest_client_id" />
              <label class="form-label">Client Secret:</label>
              <input type="text" class="form-control" id="dest_client_secret" />
              <label class="form-label">Region:</label>
              <input type="text" class="form-control" id="dest_region" />
            </div>
          </div>

          <div class="row align-items-start">
            <div class="col">
              Configuration Items
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="genesyscloud_architect_datatable" checked />
                <label class="form-check-label" for="genesyscloud_architect_datatable">Data Tables</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="genesyscloud_flow" checked />
                <label class="form-check-label" for="genesyscloud_flow">Flows</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="genesyscloud_routing_queue" checked />
                <label class="form-check-label" for="genesyscloud_routing_queue">Queues</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="genesyscloud_routing_skill" checked />
                <label class="form-check-label" for="genesyscloud_routing_skill">Skills</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="genesyscloud_user" checked />
                <label class="form-check-label" for="genesyscloud_user">Users</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="genesyscloud_user_roles" checked />
                <label class="form-check-label" for="genesyscloud_user_roles">Roles</label>
              </div>
            </div>
          </div>

          <button id="manualRun" class="btn btn-primary" onClick="handleApplyManualRun()">Manual Run</button>
        </div>
      </div>

      <div class="tab-pane fade" id="nav-profile" role="tabpanel" aria-labelledby="nav-profile-tab">
        <div class="container-fluid">
          <table class="table table-striped table-sm">
            <thead class="thead-light">
              <tr>
                <th>Name</th>
                <th>Event</th>
                <th>Date</th>
                <th>Status</th>
                <th>Conclusion</th>
              </tr>
            </thead>
            <tbody id="tableContents"></tbody>
          </table>
        </div>
      </div>
    </div>
  </body>

  <script>
    var githubToken = '';
    var githubActionName = '';
    var rememberToken = true;

    const personalTokenOnChange = async () => {
      console.log('personalTokenOnChange()');
      githubToken = $('#github-personal-token').val();
    };

    const callAxios = async (url, method, authorization, body) => {
      console.log('callAxios', url, method, authorization, body);
      try {
        const result = await axios({
          url: url,
          method: method,
          headers: {
            'Content-Type': 'application/json',
            Authorization: authorization // PAT for now hardcoded, removed later
          },
          data: body ? JSON.stringify(body) : null,
        });

        console.log(`Response`, result.data);

        return result.data;
      } catch (errors) {
        console.error(errors);
      }
    };

    const handleSelectedRepository = async() => {
      console.log('handleSelectedRepository()');
    }

    const log = async (step) => {
      try {
        const data = {
          date: moment().format(),
          userinfo: {
            id: 'webPage',
            orgId: 'unknown',
            orgName: 'unknown',
          },
          activity: {
            action: 'View',
            source: 'web',
            stage: 'BusinessContinuityApp',
            step: step,
            message: `Accessed ${window.location.origin}${window.location.pathname}`,
            object: {
              type: 'Page',
              host: window.location.host,
              hostname: window.location.hostname,
              href: window.location.href,
              origin: window.location.origin,
              pathname: window.location.pathname,
              url: window.location.origin + window.location.pathname,
            },
          },
        };
        //console.log('[Tracking] data:', data);
        logUrl = isLocalhost ? 'api.dev.ccportal.genesys.com' : 'ccportal.genesys.com';
        callAxios(`https://${logUrl}/logging/messages`, 'POST', `Bearer ${githubToken}`, data);
      } catch (errors) {
        console.error(errors);
      }
    };

    const handleRememberCheck = (e) => {
      console.log('handleRememberCheck()');
      rememberToken = $('#remember-token').prop('checked');
    };

    const isLocalhost = () => 'localhost' === window.location.host;

    const onSetConfiguration = (config) => {
      console.log(!$('#src_client_id').val());

      if (!$('#src_client_id').val() || !$('#src_client_secret').val() || !$('#src_region').val()) return alert('Source organization must be inputted and verified before continuing');
      if (!$('#dest_client_id').val() || !$('#dest_client_secret').val() || !$('#dest_region').val()) return alert('Detination organization must be inputted and verified before continuing');
    };

    const handleApplyToken = async () => {
      console.log('handleApplyToken()');
      if (githubToken?.length > 1) {
        $('#no-token-entered').hide();
        $('#token-entered-tab-control').show();
        $('#token-entered-tab-content').show();

 
        if (rememberToken) {
          localStorage.setItem('github-token', githubToken);
        }
        await log('Logged-In');
        const data = await callAxios('https://api.github.com/repos/ccportal/github-actions-tf/actions/runs', 'GET',`Bearer ${githubToken}`);

        // Feed the table with the data from GitHub
        var table = document.getElementById('tableContents');
        var tableContents = '';
        data.workflow_runs.forEach(function (item) {
          if (item.name === githubActionName) {
            let conclusion = item.conclusion === 'success' ? '<i class="bi bi-check-circle-fill" style="color:green"></i>' : item.conclusion === 'cancelled' ? '<i class="bi bi-exclamation-circle-fill"  style="color:gray"></i>' : '<i class="bi bi-x-circle-fill"  style="color:red"></i>';

            tableContents = tableContents + `<tr><td><a target="_blank" href="${item.html_url}">${item.name}</href></td><td>${item.event}</td><td>${moment(item.run_started_at).format('YYYY-MM-DD HH:mm:ss')}</td><td>${item.status}</td><td>${conclusion}</td></tr>`;
          }
        });
        table.innerHTML = tableContents;
      }
    };

    const handleApplyManualRun = async () => {
      console.log('handleApplyManualRun()');   
      
      //save configuration items
     
    }

    const handleClearToken = async () => {
      console.log('handleClearToken()');
      $('#github-personal-token').val('');
      localStorage.removeItem('github-token');
    };

    const init = async () => {
      console.log('init()');
      githubToken = localStorage.getItem('github-token') ?? '';
      $('#github-personal-token').val(githubToken);
      $('#token-entered-tab-control').hide();
      $('#token-entered-tab-content').hide();
      await log('Home');
      // loadConfigurationItems();
    };

    init();

    $(document).ready(function () {
      try {
        $.get('/.github/workflows/terraform.yml').done(function (data) {
          console.log('File load complete');
          githubActionName = jsyaml.load(data).name;
          console.log('githubActionName:', githubActionName);
        });
      } catch (error) {
        console.error(error);
      }
    });
  </script>
</html>
