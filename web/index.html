<html>
  <head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://momentjs.com/downloads/moment.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="application/json" src="availableResources.json"></script>
  </head>
  <body>
    <nav class="navbar bg-light">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <i class="bi bi-activity"></i>
          Business Continuity
        </a>
        <div class="d-flex">
          <button id="btn-login" onclick="handleLoginBtn()" type="button" class="btn btn-primary"><i class="bi bi-box-arrow-in-right"></i> Login</button>
          <button id="btn-logout" onclick="handleLogoutBtn()" type="button" class="btn btn-danger"><i class="bi bi-box-arrow-right"></i> Logout</button>
        </div>
      </div>
    </nav>

    <nav>
      <div class="nav nav-tabs" id="nav-tab" role="tablist">
        <button class="nav-link active" id="nav-home-tab" data-bs-toggle="tab" data-bs-target="#nav-home" type="button" role="tab" aria-controls="nav-home" aria-selected="true">Configuration</button>
        <button class="nav-link" id="nav-profile-tab" data-bs-toggle="tab" data-bs-target="#nav-profile" type="button" role="tab" aria-controls="nav-profile" aria-selected="false">History</button>
      </div>
    </nav>
    <div class="tab-content" id="nav-tabContent">
      <div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab">
        <div class="container">
             <div class="row align-items-start">
                <div class="col">
                  <!-- Home Org Input-->
                  <div >Source</div>
                  <label class="form-label">Client ID:</label>
                  <input type="text" class="form-control" id="src_client_id"/>
                  <label class="form-label">Client Secret:</label>
                  <input type="text" class="form-control" id="src_client_secret/">
                  <label class="form-label">Region:</label>
                  <input type="text" class="form-control" id="src_region"/>
                  <button type="submit" id="src_verify_button" class="btn btn-primary" onClick="verifyOrg('src')">Verify</button>
                  <br/>
                </div>
                <div class="col">
                <!-- Home Org Input-->
                  <div>Destination</div>
                <label class="form-label">Client ID:</label>
                <input type="text" class="form-control" id="dest_client_id">
                <label class="form-label">Client Secret:</label>
                <input type="text" class="form-control" id="dest_client_secret">
                <label class="form-label">Region:</label>
                <input type="text" class="form-control" id="dest_region">
                <button type="submit" id="dest_verify_button"  class="btn btn-primary" onClick="verifyOrg('dest')">Verify</button>
              </div>
            </div>
            <div class="row align-items-start">
              <div class="col">
                Configuration Items:
              </div>
          </div>
      

      </div>
      </div>  
      <div class="tab-pane fade" id="nav-profile" role="tabpanel" aria-labelledby="nav-profile-tab">History</div>
    </div>
  </body>
  <script>
    var githubToken;

    const GITHUB_TOKEN = '';
             
    const callAxios = async (url, method, body) => {
      const BASE_URL = 'https://api.github.com/repos/ccportal/github-actions-tf/actions/runs';
      console.log('token', githubToken);
      try {
        const result = await axios({
          url: url,
          method: method,
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${githubToken}`, // PAT for now hardcoded, removed later
          },
          data: body ? JSON.stringify(body) : null,
        });

        console.log(`Response`, result.data);

        return result.data;
      } catch (errors) {
        console.error(errors);
      }
    };

    const log = async (step) => {
      try { 
      const data = {
          date: moment().format(),
          userinfo: {
            id: 'webPage',
            orgId: 'unknown',
            orgName: 'unknown' 
          },
          activity: {
            action: "View",
            source:"web",          
            stage: "BusinessContinuityApp",
            step: step,
            message: `Accessed ${window.location.origin}${window.location.pathname}`,
            object :{
              type: "Page",
              host: window.location.host,
              hostname: window.location.hostname,
              href: window.location.href,
              origin: window.location.origin,
              pathname: window.location.pathname,
              url: window.location.origin + window.location.pathname
            },
          
      },
    };
      
      console.log('[Tracking] data:', data);   
      callAxios('https://api.dev.ccportal.genesys.com/logging/messages','POST', data);
            

      } catch (errors) {
        console.error(errors);
      }
    };

    

    const handleLoginBtn = () => {
      console.log('handleLoginBtn()');
      let redirectUri, clientId;
      if (true === isLocalhost()) {
        clientId = 'a5ebd9911ada00cd8d34';
        redirectUri = 'https://localhost/web/index.html';
      } else {
        clientId = 'aaf007c288a3586bb2da';
        redirectUri = 'https://ccportal.github.io/github-actions-tf/web/index.html';
      }
      const loginUrl = `https://github.com/login/oauth/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}`;
      console.log('loginUrl:', loginUrl);
      window.location.href = loginUrl;
    };

    const handleLogoutBtn = () => {
      console.log('handleLogoutBtn()');
    };

    const isLocalhost = () => 'localhost' === window.location.host;

    const getGithubCode = () => {
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      return code;
    };

    const getGithubToken = (code) => {
      return '123';
    }

    const verifyOrg = (orgType) => {
     //TODO: Check the auth is valid

     //disable the input boxes
     $(`#${orgType}_client_id`).prop('disabled', true);
     $(`#${orgType}_client_secret`).prop('disabled', true);
     $(`#${orgType}_region`).prop('disabled', true);
     $(`#${orgType}_verify_button`).prop('disabled', true);
    }

    const onSetConfiguration = (config) => {
      console.log('Setting Configuration', config);
    }

    const loadConfigurationItems = () => {
     
     console.log('!! Data', resources);
     var mydata = JSON.parse(data);
   }

    const init = async () => {
      console.log('init()');      
      const githubCode = getGithubCode();      
      githubToken = getGithubToken(githubCode);

      if (githubCode) {
        $('#btn-login').hide();
        //await callAxios('https://api.github.com/repos/ccportal/github-actions-tf/actions/runs','GET');
        await log('Logged in');
      } else {
        $('#btn-logout').hide();
        await log('Logged out');
      }

      loadConfigurationItems();
    };

    log('Home');
    init();
  </script>
</html>
