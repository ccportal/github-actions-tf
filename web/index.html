<html>
  <head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css" />
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://momentjs.com/downloads/moment.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js" integrity="sha512-CSBhVREyzHAjAFfBlIBakjoRUKp5h7VSweP0InR/pAJyptH7peuhCsqAI/snV+TwZmXZqoUklpXp6R6wMnYf5Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  </head>
  <body>
    <div class="main">
      <nav class="navbar bg-dark">
        <div class="container-fluid">
          <a class="navbar-brand" href="#">
            <i class="bi bi-activity"></i>
            Business Continuity
          </a>
          <div class="d-flex">
            <button id="save-btn" type="button" class="btn btn-primary mr-5" onclick="handleSetConfiguration()">Save</button>
            <button id="manual-run-btn" type="button" class="btn btn-primary" disabled onclick="handleApplyManualRun()">Manual run</button>
          </div>
        </div>
      </nav>

      <div id="no-token-entered" class="container p-4">
        <div class="card">
          <div class="card-header"><i class="bi bi-unlock"></i> Access</div>
          <div class="card-body">
            <div class="input-group">
              <span class="input-group-text" id="basic-addon1">Github Personal Token</span>
              <input id="github-personal-token" type="text" class="form-control" placeholder="enter a valid token" aria-label="Username" aria-describedby="basic-addon1" onchange="personalTokenOnChange()" />
            </div>
            <div class="d-flex justify-content-end">
              <div class="form-check mt-1">
                <input class="form-check-input" type="checkbox" id="remember-token" onchange="handleRememberCheck()" checked />
                <label class="form-check-label" for="remember-token"> Remember the token </label>
              </div>
            </div>
            <div class="d-flex justify-content-center">
              <button type="button" class="btn btn-primary mt-3" onclick="handleApplyToken()">Apply</button>
              <button type="button" class="btn btn-default mt-3" onclick="handleClearToken()">Clear</button>
            </div>
          </div>
        </div>
      </div>

      <div id="token-entered-columns" class="p-4">
        <div class="row">
          <div class="col-2">
            <div class="card">
              <div class="card-header black"><i class="bi bi-gear"></i> Configuration</div>
              <div class="card-body">
                <div>
                  <label class="form-check-label" for="select-repository"> Repository</label>
                  <select class="form-select" id="select-repository" onchange="handleSelectedRepository()">
                    <option id="blank" selected></option>
                  </select>
                </div>

                <div class="mt-3">Configuration Items</div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="genesyscloud_architect_datatable" checked />
                  <label class="form-check-label" for="genesyscloud_architect_datatable">Data Tables</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="genesyscloud_flow" checked />
                  <label class="form-check-label" for="genesyscloud_flow">Flows</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="genesyscloud_routing_queue" checked />
                  <label class="form-check-label" for="genesyscloud_routing_queue">Queues</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="genesyscloud_routing_skill" checked />
                  <label class="form-check-label" for="genesyscloud_routing_skill">Skills</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="genesyscloud_user" checked />
                  <label class="form-check-label" for="genesyscloud_user">Users</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="genesyscloud_user_roles" checked />
                  <label class="form-check-label" for="genesyscloud_user_roles">Roles</label>
                </div>

                <div class="mt-3">Schedule</div>
                <select class="form-select" id="cron-day">
                  <option value="*" selected>Everyday</option>
                  <option value="MON">Monday</option>
                  <option value="TUE">Tuesday</option>
                  <option value="WED">Wednesday</option>
                  <option value="THU">Thursday</option>
                  <option value="FRI">Friday</option>
                  <option value="SAT">Saturday</option>
                  <option value="SUN">Sunday</option>
                </select>
                <select class="form-select" id="cron-hour">
                  <option value="0" selected>at 00:00</option>
                  <option value="1">at 01:00</option>
                  <option value="2">at 02:00</option>
                  <option value="3">at 03:00</option>
                  <option value="4">at 04:00</option>
                  <option value="5">at 05:00</option>
                  <option value="0">at 06:00</option>
                  <option value="7">at 07:00</option>
                  <option value="8">at 08:00</option>
                  <option value="9">at 09:00</option>
                  <option value="10">at 10:00</option>
                  <option value="11">at 11:00</option>
                  <option value="12">at 12:00</option>
                  <option value="13">at 13:00</option>
                  <option value="14">at 14:00</option>
                  <option value="15">at 15:00</option>
                  <option value="16">at 16:00</option>
                  <option value="17">at 17:00</option>
                  <option value="18">at 18:00</option>
                  <option value="19">at 19:00</option>
                  <option value="20">at 20:00</option>
                  <option value="21">at 21:00</option>
                  <option value="22">at 22:00</option>
                  <option value="23">at 23:00</option>
                </select>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card">
              <div class="card-header"><i class="bi bi-box-arrow-up"></i> Source</div>
              <div class="card-body">
                <label class="form-label">Client Id</label>
                <input type="text" class="form-control input--style" id="src_client_id" value="304bd193-4dd0-453b-858a-02ca6b64eb2d" />
                <label class="form-label">Client Secret</label>
                <input type="password" class="form-control input--style" id="src_client_secret" value="jbnmSZTIMlHIxjY9LZ0YYlVrVYiAa6gDih30tk16ELY" />
                <label class="form-label" for="src-region">Region:</label>
                <select class="form-select" id="src_region">
                  <option id="blank" selected></option>
                  <option id="mypurecloud.com">Americas (US East)</option>
                  <option id="use2.us-gov-pure.cloud">Americas (US East 2)</option>
                  <option id="usw2.pure.cloud">Americas (US West)</option>
                  <option id="cac1.pure.cloud">Americas (Canada)</option>
                  <option id="mypurecloud.de">EMEA (Frankfurt))</option>
                  <option id="mypurecloud.ie">EMEA (Dublin)</option>
                  <option id="euw2.pure.cloud">EMEA (London)</option>
                  <option id="uaps1.pure.cloud">Asia Pacific (Mumbai)</option>
                  <option id="apne2.pure.cloud">Asia Pacific (Seoul)</option>
                  <option id="mypurecloud.com.au">Asia Pacific (Sydney)</option>
                  <option id="mypurecloud.jp">Asia Pacific (Tokyo)</option>
                </select>
              </div>
            </div>

            <div class="card mt-4">
              <div class="card-header"><i class="bi bi-box-arrow-in-down"></i> Destination</div>
              <div class="card-body">
                <div class="input-group-desc">
                  <label class="form-label">Client Id</label>
                  <input type="text" class="form-control input--style" id="dest_client_id" value="e50d2e78-22c6-456a-aabd-8216be13a0ab" />
                  <label class="form-label">Client Secret</label>
                  <input type="text" class="form-control input--style" id="dest_client_secret" value="dPqlWUUctAo9kAfgSen1fkpPsyiU0047kB33NOcYifo" />
                  <label class="form-label" for="dest-region">Region:</label>
                  <select class="form-select" id="dest_region">
                    <option id="blank" selected></option>
                    <option id="mypurecloud.com">Americas (US East)</option>
                    <option id="use2.us-gov-pure.cloud">Americas (US East 2)</option>
                    <option id="usw2.pure.cloud">Americas (US West)</option>
                    <option id="cac1.pure.cloud">Americas (Canada)</option>
                    <option id="mypurecloud.de">EMEA (Frankfurt))</option>
                    <option id="umypurecloud.ie">EMEA (Dublin)</option>
                    <option id="euw2.pure.cloud">EMEA (London)</option>
                    <option id="uaps1.pure.cloud">Asia Pacific (Mumbai)</option>
                    <option id="apne2.pure.cloud">Asia Pacific (Seoul)</option>
                    <option id="mypurecloud.com.au">Asia Pacific (Sydney)</option>
                    <option id="mypurecloud.jp">Asia Pacific (Tokyo)</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div class="col-3">
            <div class="card">
              <div class="card-header"><i class="bi bi-clock-history"></i> History</div>
              <div class="card-body">
                <table class="table table-striped table-sm clickable-row">
                  <div id="spinnerHistory" class="spinner-border" role="status" hidden>
                    <span class="sr-only"></span>
                  </div>
                  <thead class="thead-light">
                    <tr>
                      <th>Date</th>
                      <th>Conclusion</th>
                    </tr>
                  </thead>
                  <tbody id="tableContents"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>

  <script>
    var githubToken = '';
    var githubActionName = '';
    var githubRepository = '';
    var githubWorkflowId = undefined;
    var rememberToken = true;
    var githubRepositories = [];

    const personalTokenOnChange = async () => {
      console.log('personalTokenOnChange()');
      githubToken = $('#github-personal-token').val();
    };

    const callAxios = async (url, method, authorization, body, suppressExceptions = false) => {
      console.log('callAxios', url, method);
      try {
        const result = await axios({
          url: url,
          method: method,
          headers: {
            'Content-Type': 'application/json',
            Authorization: authorization, // PAT for now hardcoded, removed later
          },
          data: body ? JSON.stringify(body) : null,
        });

        console.log(`Response`, result.data);

        return result.data;
      } catch (errors) {
        console.error(errors);
        if (!suppressExceptions) throw errors;
      }
    };

    const clearUI = () => {
      console.log('clearUI()');

      githubWorkflowId = undefined;
      document.getElementById('tableContents').innerHTML = '';
      document.getElementById('manual-run-btn').disabled = true;
    };

    const handleSelectedRepository = async () => {
      githubRepository = $('#select-repository option:selected').text();

      console.log('Set Repository:', githubRepository);

      // Clean vars / tables
      clearUI();
      document.getElementById('spinnerHistory').hidden = false;
      // Get WorkflowId
      console.log('Find workflowId...');
      try {
        const workflow_Ids = await callAxios(`https://api.github.com/repos/${githubRepository}/actions/workflows`, 'GET', `Bearer ${githubToken}`);
        if (!workflow_Ids?.workflows) {
          console.log('No workflows found');
          return;
        }
        workflow_Ids.workflows.forEach((item) => {
          if (item.name === githubActionName) githubWorkflowId = item.id;
        });
        console.log('githubWorkflowId:', githubWorkflowId);
        if (!githubWorkflowId) {
          console.log('GitHubWorkflowId not set.');
          return;
        }

        // Enable ManualRun Button
        document.getElementById('manual-run-btn').disabled = false;

        // Load History
        console.log('Load History...');
        const data = await callAxios(`https://api.github.com/repos/${githubRepository}/actions/workflows/${githubWorkflowId}/runs?per_page=10`, 'GET', `Bearer ${githubToken}`);
        // Feed the table with the data from GitHub

        var table = document.getElementById('tableContents');
        var tableContents = '';

        data.workflow_runs.forEach(function (item) {
          if (item.name === githubActionName) {
            let conclusion = '';
            if (item.conclusion) {
              conclusion = item.conclusion === 'success' ? '<i class="bi bi-check-circle-fill" style="color:green" data-toggle="tooltip" data-placement="right" title="Success"></i>' : item.conclusion === 'cancelled' ? '<i class="bi bi-exclamation-circle-fill"  style="color:gray" data-toggle="tooltip" data-placement="right" title="Cancelled"></i>' : '<i class="bi bi-x-circle-fill"  style="color:red" data-toggle="tooltip" data-placement="right" title="Failed"></i>';
            } else {
              conclusion = '';
            }
            tableContents = tableContents + `<tr><td><a target="_blank" href="${item.html_url}">${moment(item.run_started_at).format('YYYY-MM-DD HH:mm:ss')}</href></td><td class="text-center">${conclusion}</td></tr>`;
          }
        });
        table.innerHTML = tableContents;
      } catch (error) {
        console.error(error);
      } finally {
        document.getElementById('spinnerHistory').hidden = true;
      }

      if (rememberToken) {
        localStorage.setItem('github-repository', githubRepository);
      }

      //#region Test Secrets
      console.log('Load Secrets...');
      let resp = await callAxios(`https://api.github.com/repos/${githubRepository}/actions/secrets`, 'GET', `Bearer ${githubToken}`);
      console.log(resp.data);

      // Test Create Secret
      let secret = {
        encrypted_value: 'test-secret',
        key_id: 'test-secret-value',
      };
      resp = await callAxios(`https://api.github.com/repos/${githubRepository}/actions/secrets/TEST_SECRET`, 'PUT', `Bearer ${githubToken}`, secret);

      //#endregion /Test Secrets
    };

    const log = async (step) => {
      try {
        const data = {
          date: moment().format(),
          userinfo: {
            id: 'webPage',
            orgId: 'unknown',
            orgName: 'unknown',
          },
          activity: {
            action: 'View',
            source: 'web',
            stage: 'BusinessContinuityApp',
            step: step,
            message: `Accessed ${window.location.origin}${window.location.pathname}`,
            object: {
              type: 'Page',
              host: window.location.host,
              hostname: window.location.hostname,
              href: window.location.href,
              origin: window.location.origin,
              pathname: window.location.pathname,
              url: window.location.origin + window.location.pathname,
            },
          },
        };
        //console.log('[Tracking] data:', data);
        logUrl = isLocalhost ? 'api.dev.ccportal.genesys.com' : 'ccportal.genesys.com';
        callAxios(`https://${logUrl}/logging/messages`, 'POST', `Bearer ${githubToken}`, data);
      } catch (errors) {
        console.error(errors);
      }
    };

    const handleRememberCheck = (e) => {
      console.log('handleRememberCheck()');
      rememberToken = $('#remember-token').prop('checked');
    };

    const pushToGithub = () => {};

    const isLocalhost = () => 'localhost' === window.location.host;

    const handleSetConfiguration = async (config) => {
      //Validation:
      // if (!$("#src_client_id").val() || !$("#src_client_secret").val() || $("#src_region option:selected")[0].innerText === "") return alert("Source organization must be inputted before continuing");
      // if (!$("#dest_client_id").val() || !$("#dest_client_secret").val() || $("#dest_region option:selected")[0].innerText === "") return alert("Destination organization must be inputted before continuing");
      // if ($("#select-repository option:selected")[0].innerText === "") return alert("Repository must be selected");

      await updateConfigurationItems();
      await updateGitSecrets();
      await saveDeploymentDetails();
    };

    const updateConfigurationItems = async () => {
      //Get the existing Configuration file:
      const existingExportFile = await callAxios(`https://api.github.com/repos/${githubRepository}/contents/source/export.tf`, 'GET', `Bearer ${githubToken}`);
      console.log('File Found:', existingExportFile);

      $.get('/web/export.tf').done(async function (data) {
        console.log('File load complete', data);
        //[ "genesyscloud_routing_language"]
        var newData = '["genesyscloud_routing_language", "genesyscloud_routing_skills"]';
        let updatedData = data.toString().replace('###RESOURCES###', newData);
        let amendedData = btoa(updatedData);
        console.log('Updated Data:', amendedData);

        const body = {
          owner: githubRepository.split('/')[0],
          repo: githubRepository.split('/')[1],
          path: '/source/export.tf',
          message: 'Updated Resources for export',
          content: amendedData,
          sha: existingExportFile.sha,
        };
        console.log('Updating content with body:', body);
        const updateDoc = await callAxios(`https://api.github.com/repos/${githubRepository}/contents/source/export.tf`, 'PUT', `Bearer ${githubToken}`, body);
        console.log('Updated Data', updateDoc);
      });
    };

    const updateGitSecrets = async () => {};

    const saveDeploymentDetails = async () => {};

    const handleApplyToken = async () => {
      console.log('handleApplyToken()');
      if (githubToken?.length > 1) {
        if (rememberToken) {
          localStorage.setItem('github-token', githubToken);
        }
        await log('Logged-In');
        try {
          await loadRepositories(githubToken);
          $('#no-token-entered').hide();
          $('#token-entered-columns').show();
          $('#save-btn').show();
          $('#manual-run-btn').show();
        } catch (err) {
          console.log(err);
          alert('Invalid token');
        }
        await log('Logged-In');
        //#region Test Secrets

        //#endregion /Test Secrets

        await loadRepositories(githubToken);
      }
    };

    const handleApplyManualRun = async () => {
      console.log('handleApplyManualRun()');
      await callAxios(`https://api.github.com/repos/${githubRepository}/actions/workflows/${githubWorkflowId}/dispatches`, 'POST', `Bearer ${githubToken}`, { ref: 'master' });
    };

    const loadRepositories = async (githubToken) => {
      console.log('Loading Repositories...');
      let repositories = await callAxios('https://api.github.com/user/repos', 'GET', `Bearer ${githubToken}`);
      repositories = repositories.sort((a, b) => a.full_name.localeCompare(b.full_name));
      githubRepositories = repositories;
      console.log('repositories:', repositories);
      //Update the select with the repositories
      for (let i = 0; i < repositories.length; i++) {
        $('#select-repository').append(
          $('<option>', {
            value: repositories[i].name,
            text: repositories[i].full_name,
          })
        );
      }

      console.log('Repositories found:', repositories);
    };

    const handleClearToken = async () => {
      console.log('handleClearToken()');
      $('#github-personal-token').val('');
      localStorage.removeItem('github-token');
    };

    const getSchedule = () => {
      console.log('getSchedule()');
      const day = $('#cron-day').val();
      const hour = $('#cron-hour').val();
      const cron = `* * ${hour} * * ${day}`;
      console.log({ day, hour, cron });
      return cron;
    };

    const setSchedule = (cronString) => {
      console.log('setSchedule()');
      const parsed = cronString.split(' ');
      let hour = parsed[2]?.split(',')[0] ?? '0';
      if (hour === '?') hour === '*';
      const dayTemp = parsed[5] ?? '*';
      let day = '';
      if (dayTemp.includes('-')) day = dayTemp.split('-')[0];
      else if (dayTemp.includes(',')) day = dayTemp.split(',')[0];
      else day = dayTemp;
      $('#cron-day').val(day).change();
      $('#cron-hour').val(hour).change();
    };

    const init = async () => {
      console.log('init()');
      githubToken = localStorage.getItem('github-token') ?? '';
      $('#github-personal-token').val(githubToken);
      $('#token-entered-columns').hide();
      $('#save-btn').hide();
      $('#manual-run-btn').hide();
      await log('Home');
      // loadConfigurationItems();
    };

    init();

    $(document).ready(function () {
      try {
        console.log('Get terraform file');
        $.get('/.github/workflows/terraform.yml').done(function (data) {
          console.log('File load complete');
          githubActionName = jsyaml.load(data).name;
          console.log('githubActionName:', githubActionName);
        });
      } catch (error) {
        console.error(error);
      }
    });
  </script>
</html>
